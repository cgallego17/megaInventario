{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Asignar Múltiples Productos a Parejas - Mega Inventario{% endblock %}

{% block content %}
<div class="container-fluid mt-3 px-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h3 mb-0">
            <i class="bi bi-people-fill"></i> Asignar Múltiples Productos a Parejas
        </h1>
        <a href="{% url 'productos:lista' %}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>

    <!-- Filtros de Productos -->
    <div class="card shadow-sm mb-3">
        <div class="card-body p-3">
            <form method="get" class="mb-2">
                <div class="row g-2 mb-2">
                    <div class="col-md-6">
                        <input type="text" name="busqueda" class="form-control form-control-sm" placeholder="Buscar por ID, código, nombre, marca, atributo..." value="{{ busqueda }}" autofocus>
                    </div>
                    <div class="col-md-2">
                        <select name="marca" class="form-select form-select-sm">
                            <option value="">Todas las marcas</option>
                            {% for marca in marcas %}
                                <option value="{{ marca }}" {% if marca_filtro == marca %}selected{% endif %}>{{ marca }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select name="categoria" class="form-select form-select-sm">
                            <option value="">Todas las categorías</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria }}" {% if categoria_filtro == categoria %}selected{% endif %}>{{ categoria }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <form method="post" id="form-asignar">
        {% csrf_token %}
        
        <!-- Selección de Parejas -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-people"></i> Seleccionar Parejas</h5>
            </div>
            <div class="card-body">
                {% if parejas_activas %}
                    <div class="row">
                        {% for pareja in parejas_activas %}
                            <div class="col-md-6 col-lg-4 mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="parejas" value="{{ pareja.pk }}" id="pareja_{{ pareja.pk }}">
                                    <label class="form-check-label" for="pareja_{{ pareja.pk }}">
                                        <span class="badge bg-{{ pareja.color }}">{{ pareja.usuario_1.username }} & {{ pareja.usuario_2.username }}</span>
                                    </label>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="seleccionarTodasParejas()">Seleccionar Todas</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deseleccionarTodasParejas()">Deseleccionar Todas</button>
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i> No hay parejas activas disponibles.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Lista de Productos -->
        <div class="card shadow-sm mb-3">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-box"></i> Seleccionar Productos</h5>
                <div>
                    <button type="button" class="btn btn-sm btn-light" onclick="seleccionarTodos()">Seleccionar Todos</button>
                    <button type="button" class="btn btn-sm btn-light" onclick="deseleccionarTodos()">Deseleccionar Todos</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 50px;" class="text-center">
                                    <input type="checkbox" id="select-all" onchange="toggleTodos(this)">
                                </th>
                                <th style="width: 60px;">Imagen</th>
                                <th>Código Barras</th>
                                <th>Nombre</th>
                                <th>Atributo</th>
                                <th>Marca</th>
                                <th>Parejas Asignadas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for producto in page_obj %}
                            <tr>
                                <td class="text-center">
                                    <input type="checkbox" name="productos" value="{{ producto.pk }}" class="producto-checkbox">
                                </td>
                                <td>
                                    {% if producto.imagen %}
                                        <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="img-thumbnail" style="width: 40px; height: 40px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; border-radius: 4px;">
                                            <i class="bi bi-image text-muted" style="font-size: 0.75rem;"></i>
                                        </div>
                                    {% endif %}
                                </td>
                                <td class="small">{{ producto.codigo_barras }}</td>
                                <td>
                                    <div class="text-truncate" style="max-width: 200px;" title="{{ producto.nombre }}">
                                        {{ producto.nombre }}
                                    </div>
                                </td>
                                <td>
                                    {% if producto.atributo %}
                                        <span class="badge bg-secondary" style="font-size: 0.75rem;">{{ producto.atributo }}</span>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if producto.marca %}
                                        <span class="badge bg-info" style="font-size: 0.75rem;">{{ producto.marca }}</span>
                                    {% else %}
                                        <span class="text-muted small">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for pareja in producto.parejas_asignadas.all %}
                                        <span class="badge bg-{{ pareja.color }} me-1" style="font-size: 0.7rem;">{{ pareja.usuario_1.username }} & {{ pareja.usuario_2.username }}</span>
                                    {% empty %}
                                        <span class="text-muted small">Sin asignar</span>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">No hay productos registrados</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Acciones -->
        <div class="card shadow-sm mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span id="productos-seleccionados" class="badge bg-primary">0 productos seleccionados</span>
                        <span id="parejas-seleccionadas" class="badge bg-info ms-2">0 parejas seleccionadas</span>
                    </div>
                    <div>
                        <input type="hidden" name="accion" id="accion-hidden" value="asignar">
                        <button type="submit" name="accion" value="asignar" class="btn btn-success" onclick="document.getElementById('accion-hidden').value='asignar'; return validarSeleccion();">
                            <i class="bi bi-plus-circle"></i> Asignar Productos Seleccionados
                        </button>
                        <button type="submit" name="accion" value="desasignar" class="btn btn-danger" onclick="document.getElementById('accion-hidden').value='desasignar'; return validarSeleccion();">
                            <i class="bi bi-x-circle"></i> Desasignar Productos Seleccionados
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Paginación -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation">
        <ul class="pagination pagination-sm justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if marca_filtro %}&marca={{ marca_filtro }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            <li class="page-item active">
                <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
            </li>
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if busqueda %}&busqueda={{ busqueda }}{% endif %}{% if marca_filtro %}&marca={{ marca_filtro }}{% endif %}{% if categoria_filtro %}&categoria={{ categoria_filtro }}{% endif %}">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
function seleccionarTodos() {
    document.querySelectorAll('.producto-checkbox').forEach(cb => cb.checked = true);
    document.getElementById('select-all').checked = true;
    actualizarContadores();
}

function deseleccionarTodos() {
    document.querySelectorAll('.producto-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('select-all').checked = false;
    actualizarContadores();
}

function toggleTodos(checkbox) {
    document.querySelectorAll('.producto-checkbox').forEach(cb => cb.checked = checkbox.checked);
    actualizarContadores();
}

function seleccionarTodasParejas() {
    document.querySelectorAll('input[name="parejas"]').forEach(cb => cb.checked = true);
    actualizarContadores();
}

function deseleccionarTodasParejas() {
    document.querySelectorAll('input[name="parejas"]').forEach(cb => cb.checked = false);
    actualizarContadores();
}

function actualizarContadores() {
    const productosSeleccionados = document.querySelectorAll('input[name="productos"]:checked').length;
    const parejasSeleccionadas = document.querySelectorAll('input[name="parejas"]:checked').length;
    
    document.getElementById('productos-seleccionados').textContent = productosSeleccionados + ' productos seleccionados';
    document.getElementById('parejas-seleccionadas').textContent = parejasSeleccionadas + ' parejas seleccionadas';
}

function validarSeleccion() {
    const productosSeleccionados = document.querySelectorAll('input[name="productos"]:checked').length;
    const parejasSeleccionadas = document.querySelectorAll('input[name="parejas"]:checked').length;
    
    if (productosSeleccionados === 0) {
        alert('Debe seleccionar al menos un producto.');
        return false;
    }
    
    if (parejasSeleccionadas === 0) {
        alert('Debe seleccionar al menos una pareja.');
        return false;
    }
    
    return confirm(`¿Está seguro de ${document.getElementById('accion-hidden').value === 'asignar' ? 'asignar' : 'desasignar'} ${productosSeleccionados} producto(s) a ${parejasSeleccionadas} pareja(s)?`);
}

// Actualizar contadores cuando cambian las selecciones
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[name="productos"], input[name="parejas"]').forEach(cb => {
        cb.addEventListener('change', actualizarContadores);
    });
    actualizarContadores();
});
</script>
{% endblock %}

