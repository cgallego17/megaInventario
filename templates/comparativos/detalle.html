{% extends 'base.html' %}
{% load humanize %}

{% block title %}Detalle Comparativo - Mega Inventario{% endblock %}

<!-- Overlay de carga inicial (se muestra al cargar la página) -->
<div id="initial-loading-overlay" class="loading-overlay">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <h5 class="mt-3 text-white">Cargando comparativo...</h5>
        <p class="text-white-50 mt-2">Por favor, espere mientras se procesan los datos.</p>
        <p class="text-white-50 small">Calculando estadísticas y preparando la información...</p>
    </div>
</div>

{% block extra_css %}
<style>
/* Ocultar scroll cuando se muestra el overlay inicial */
body:has(#initial-loading-overlay:not([style*="display: none"])) {
    overflow: hidden;
}
    .comparativo-table {
        font-size: 0.85rem;
    }
    .comparativo-table th {
        font-size: 0.75rem;
        font-weight: 600;
        white-space: nowrap;
        padding: 0.5rem 0.3rem;
        vertical-align: middle;
    }
    .comparativo-table td {
        padding: 0.5rem 0.3rem;
        vertical-align: middle;
    }
    .comparativo-table .col-producto {
        min-width: 150px;
        max-width: 200px;
    }
    .comparativo-table .col-codigo {
        min-width: 80px;
    }
    .comparativo-table .col-numero {
        text-align: center;
        min-width: 60px;
    }
    .comparativo-table .col-valor {
        text-align: right;
        min-width: 80px;
        font-weight: 500;
    }
    .comparativo-table .col-diferencia {
        text-align: center;
        min-width: 70px;
    }
    .badge-sm {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
    }
    /* Estilos para ordenamiento */
    .comparativo-table th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 1.5rem;
    }
    .comparativo-table th.sortable:hover {
        background-color: #e9ecef;
    }
    .comparativo-table th.sortable::after {
        content: '⇅';
        position: absolute;
        right: 0.5rem;
        opacity: 0.3;
        font-size: 0.8rem;
    }
    .comparativo-table th.sortable.sort-asc::after {
        content: '↑';
        opacity: 1;
        color: var(--bs-primary);
    }
    .comparativo-table th.sortable.sort-desc::after {
        content: '↓';
        opacity: 1;
        color: var(--bs-primary);
    }
    .table-light th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    .stats-card {
        padding: 0.75rem;
    }
    .stats-card h5 {
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
    }
    .stats-card h2, .stats-card h4 {
        margin-bottom: 0;
        font-size: 1.1rem;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.75);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .loading-content {
        text-align: center;
        padding: 2rem;
        background-color: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        max-width: 400px;
    }
    .loading-content .spinner-border {
        border-width: 0.3em;
    }
    @media (max-width: 768px) {
        .comparativo-table {
            font-size: 0.75rem;
        }
        .comparativo-table th,
        .comparativo-table td {
            padding: 0.3rem 0.2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-arrow-left-right"></i> {{ comparativo.nombre }}</h1>
            <div class="d-flex align-items-center gap-3 mt-2">
                <div>
                    <span class="badge bg-info text-white fs-6 px-3 py-2">
                        <i class="bi bi-1-circle"></i> {{ comparativo.nombre_sistema1|default:"Sistema 1" }}
                    </span>
                </div>
                <div>
                    <i class="bi bi-arrow-left-right text-muted"></i>
                </div>
                <div>
                    <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                        <i class="bi bi-2-circle"></i> {{ comparativo.nombre_sistema2|default:"Sistema 2" }}
                    </span>
                </div>
                <div>
                    <i class="bi bi-arrow-left-right text-muted"></i>
                </div>
                <div>
                    <span class="badge bg-primary text-white fs-6 px-3 py-2">
                        <i class="bi bi-clipboard-check"></i> Físico
                    </span>
                </div>
            </div>
            {% if conteos_finalizados %}
                <p class="text-muted mb-0 mt-2">
                    <i class="bi bi-info-circle"></i> Sumando <strong>{{ conteos_finalizados.count }}</strong> conteo(s) finalizado(s):
                    {% for conteo in conteos_finalizados %}
                        <span class="badge bg-primary me-1">Conteo {{ conteo.numero_conteo }}</span>
                    {% endfor %}
                </p>
            {% else %}
                <p class="text-warning mb-0 mt-2">
                    <i class="bi bi-exclamation-triangle"></i> No hay conteos finalizados. Procesa el comparativo para sumar los conteos.
                </p>
            {% endif %}
        </div>
        <div>
            <a href="{% url 'comparativos:subir_inventario' comparativo.pk %}" class="btn btn-warning me-2">
                <i class="bi bi-upload"></i> Subir Inventarios
            </a>
            <a href="{% url 'comparativos:procesar' comparativo.pk %}" class="btn btn-primary me-2">
                <i class="bi bi-calculator"></i> Procesar Comparativo
            </a>
            <a href="{% url 'comparativos:exportar' comparativo.pk %}" class="btn btn-success">
                <i class="bi bi-download"></i> Exportar Excel
            </a>
        </div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card text-center stats-card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-1 small">Total Items</h6>
                    <h4 class="mb-0">{{ total_items }}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card text-center stats-card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-1 small">Dif. {{ comparativo.nombre_sistema1|default:"S1" }}</h6>
                    <h4 class="mb-0 {% if items_con_diferencia_s1 > 0 %}text-danger{% else %}text-success{% endif %}">{{ items_con_diferencia_s1 }}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card text-center stats-card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-1 small">Dif. {{ comparativo.nombre_sistema2|default:"S2" }}</h6>
                    <h4 class="mb-0 {% if items_con_diferencia_s2 > 0 %}text-danger{% else %}text-success{% endif %}">{{ items_con_diferencia_s2 }}</h4>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card text-center stats-card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-1 small">Valor Físico</h6>
                    <h6 class="mb-0 text-primary format-currency">${{ total_valor_fisico|floatformat:2|intcomma }}</h6>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card text-center stats-card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-1 small">Dif. Valor {{ comparativo.nombre_sistema1|default:"S1" }}</h6>
                    <h6 class="mb-0 format-currency {% if diferencia_valor_s1 > 0 %}text-success{% elif diferencia_valor_s1 < 0 %}text-danger{% else %}text-secondary{% endif %}">
                        ${{ diferencia_valor_s1|floatformat:2|intcomma }}
                    </h6>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-4 col-lg-2">
            <div class="card text-center stats-card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-1 small">Dif. Valor {{ comparativo.nombre_sistema2|default:"S2" }}</h6>
                    <h6 class="mb-0 format-currency {% if diferencia_valor_s2 > 0 %}text-success{% elif diferencia_valor_s2 < 0 %}text-danger{% else %}text-secondary{% endif %}">
                        ${{ diferencia_valor_s2|floatformat:2|intcomma }}
                    </h6>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-3">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-2 small">Valores Totales</h6>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small">{{ comparativo.nombre_sistema1|default:"Sistema 1" }}:</span>
                        <strong class="small format-currency">${{ total_valor_sistema1|floatformat:2|intcomma }}</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="small">{{ comparativo.nombre_sistema2|default:"Sistema 2" }}:</span>
                        <strong class="small format-currency">${{ total_valor_sistema2|floatformat:2|intcomma }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="small">Físico:</span>
                        <strong class="small text-primary format-currency">${{ total_valor_fisico|floatformat:2|intcomma }}</strong>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-2 small">Conteos Finalizados</h6>
                    {% if conteos_info %}
                        {% for info in conteos_info %}
                        <div class="d-flex justify-content-between mb-1">
                            <span class="small">
                                <span class="badge bg-primary badge-sm">Conteo {{ info.conteo.numero_conteo }}</span>
                            </span>
                            <strong class="small">{{ info.total_cantidad|intcomma }} unidades</strong>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="mb-0 small text-muted">No hay conteos finalizados</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-2 small">Usuario</h6>
                    <p class="mb-1 small">{{ comparativo.usuario.get_full_name|default:comparativo.usuario.username }}</p>
                    <small class="text-muted">{{ comparativo.fecha_creacion|date:"d/m/Y H:i" }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body p-2">
                    <h6 class="text-muted mb-2 small">Observaciones</h6>
                    <p class="mb-0 small">{{ comparativo.observaciones|default:"Sin observaciones" }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header py-2">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Items Comparativos (Suma de todos los conteos finalizados)</h6>
                <span class="badge bg-secondary" id="total-items-badge">{{ total_items }} items</span>
            </div>
            <div class="row g-2">
                <div class="col-md-6">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" 
                               id="buscar-items" 
                               class="form-control" 
                               placeholder="Buscar por código, nombre, atributo...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select id="filtro-diferencia" class="form-select form-select-sm">
                        <option value="">Todas las diferencias</option>
                        <option value="s1-con-diferencia">Con diferencia S1</option>
                        <option value="s2-con-diferencia">Con diferencia S2</option>
                        <option value="sin-diferencia">Sin diferencias</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="limpiar-filtros">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body p-2">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-sm comparativo-table mb-0" id="tabla-comparativo">
                    <thead class="table-light">
                        <tr>
                            <th class="col-producto sortable" data-sort="producto">Producto</th>
                            <th class="sortable" data-sort="atributo">Atrib.</th>
                            <th class="col-codigo sortable" data-sort="codigo">Código</th>
                            <th class="col-codigo sortable" data-sort="codigo-barras">C. Barras</th>
                            <th class="sortable" data-sort="marca">Marca</th>
                            <th class="col-valor sortable" data-sort="precio">Precio</th>
                            <th colspan="2" class="text-center bg-info bg-opacity-10">{{ comparativo.nombre_sistema1|default:"Sistema 1" }}</th>
                            <th colspan="2" class="text-center bg-warning bg-opacity-10">{{ comparativo.nombre_sistema2|default:"Sistema 2" }}</th>
                            <th colspan="2" class="text-center bg-primary bg-opacity-10">Físico</th>
                            <th colspan="2" class="text-center bg-success bg-opacity-10">Dif. {{ comparativo.nombre_sistema1|default:"S1" }}</th>
                            <th colspan="2" class="text-center bg-danger bg-opacity-10">Dif. {{ comparativo.nombre_sistema2|default:"S2" }}</th>
                        </tr>
                        <tr class="table-light">
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th></th>
                            <th class="col-numero sortable" data-sort="cant-s1">Cant.</th>
                            <th class="col-valor sortable" data-sort="valor-s1">Valor</th>
                            <th class="col-numero sortable" data-sort="cant-s2">Cant.</th>
                            <th class="col-valor sortable" data-sort="valor-s2">Valor</th>
                            <th class="col-numero sortable" data-sort="cant-fisico">Cant.</th>
                            <th class="col-valor sortable" data-sort="valor-fisico">Valor</th>
                            <th class="col-diferencia sortable" data-sort="dif-cant-s1">Cant.</th>
                            <th class="col-valor sortable" data-sort="dif-valor-s1">Valor</th>
                            <th class="col-diferencia sortable" data-sort="dif-cant-s2">Cant.</th>
                            <th class="col-valor sortable" data-sort="dif-valor-s2">Valor</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr data-producto="{{ item.producto.nombre|lower }}" 
                            data-atributo="{{ item.producto.atributo|default:''|lower }}"
                            data-codigo="{{ item.producto.codigo|default:''|lower }}"
                            data-codigo-barras="{{ item.producto.codigo_barras|lower }}"
                            data-marca="{{ item.producto.marca|default:''|lower }}"
                            data-precio="{{ item.get_precio }}"
                            data-cant-s1="{{ item.cantidad_sistema1 }}"
                            data-valor-s1="{{ item.get_valor_sistema1 }}"
                            data-cant-s2="{{ item.cantidad_sistema2 }}"
                            data-valor-s2="{{ item.get_valor_sistema2 }}"
                            data-cant-fisico="{{ item.cantidad_fisico }}"
                            data-valor-fisico="{{ item.get_valor_fisico }}"
                            data-dif-cant-s1="{{ item.diferencia_sistema1 }}"
                            data-dif-valor-s1="{{ item.get_diferencia_valor_sistema1 }}"
                            data-dif-cant-s2="{{ item.diferencia_sistema2 }}"
                            data-dif-valor-s2="{{ item.get_diferencia_valor_sistema2 }}">
                            <td class="col-producto">
                                <strong class="small">{{ item.producto.nombre }}</strong>
                            </td>
                            <td>
                                <small>{{ item.producto.atributo|default:"-" }}</small>
                            </td>
                            <td class="col-codigo">
                                <small>{{ item.producto.codigo|default:"-" }}</small>
                            </td>
                            <td class="col-codigo">
                                <small class="text-muted">{{ item.producto.codigo_barras|truncatechars:12 }}</small>
                            </td>
                            <td>
                                {% if item.producto.marca %}
                                    <small><span class="badge bg-info badge-sm">{{ item.producto.marca }}</span></small>
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            </td>
                            <td class="col-valor">
                                <small class="format-currency">${{ item.get_precio|floatformat:2|intcomma }}</small>
                            </td>
                            <td class="col-numero">{{ item.cantidad_sistema1|intcomma }}</td>
                            <td class="col-valor">
                                <small class="format-currency">${{ item.get_valor_sistema1|floatformat:2|intcomma }}</small>
                            </td>
                            <td class="col-numero">{{ item.cantidad_sistema2|intcomma }}</td>
                            <td class="col-valor">
                                <small class="format-currency">${{ item.get_valor_sistema2|floatformat:2|intcomma }}</small>
                            </td>
                            <td class="col-numero">
                                <strong>{{ item.cantidad_fisico|intcomma }}</strong>
                            </td>
                            <td class="col-valor">
                                <strong class="text-primary small format-currency">${{ item.get_valor_fisico|floatformat:2|intcomma }}</strong>
                            </td>
                            <td class="col-diferencia">
                                {% if item.diferencia_sistema1 > 0 %}
                                    <span class="badge bg-success badge-sm">+{{ item.diferencia_sistema1|intcomma }}</span>
                                {% elif item.diferencia_sistema1 < 0 %}
                                    <span class="badge bg-danger badge-sm">{{ item.diferencia_sistema1|intcomma }}</span>
                                {% else %}
                                    <span class="badge bg-secondary badge-sm">0</span>
                                {% endif %}
                            </td>
                            <td class="col-valor">
                                {% if item.get_diferencia_valor_sistema1 > 0 %}
                                    <small class="text-success format-currency">+${{ item.get_diferencia_valor_sistema1|floatformat:2|intcomma }}</small>
                                {% elif item.get_diferencia_valor_sistema1 < 0 %}
                                    <small class="text-danger format-currency">${{ item.get_diferencia_valor_sistema1|floatformat:2|intcomma }}</small>
                                {% else %}
                                    <small class="text-muted">$0.00</small>
                                {% endif %}
                            </td>
                            <td class="col-diferencia">
                                {% if item.diferencia_sistema2 > 0 %}
                                    <span class="badge bg-success badge-sm">+{{ item.diferencia_sistema2|intcomma }}</span>
                                {% elif item.diferencia_sistema2 < 0 %}
                                    <span class="badge bg-danger badge-sm">{{ item.diferencia_sistema2|intcomma }}</span>
                                {% else %}
                                    <span class="badge bg-secondary badge-sm">0</span>
                                {% endif %}
                            </td>
                            <td class="col-valor">
                                {% if item.get_diferencia_valor_sistema2 > 0 %}
                                    <small class="text-success format-currency">+${{ item.get_diferencia_valor_sistema2|floatformat:2|intcomma }}</small>
                                {% elif item.get_diferencia_valor_sistema2 < 0 %}
                                    <small class="text-danger format-currency">${{ item.get_diferencia_valor_sistema2|floatformat:2|intcomma }}</small>
                                {% else %}
                                    <small class="text-muted">$0.00</small>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="16" class="text-center py-3">No hay items en este comparativo</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-info">
                        <tr>
                            <th colspan="6" class="text-end"><strong>TOTALES:</strong></th>
                            <th class="col-numero"><strong>{{ total_cantidad_sistema1|intcomma }}</strong></th>
                            <th class="col-valor"><strong class="format-currency">${{ total_valor_sistema1|floatformat:2|intcomma }}</strong></th>
                            <th class="col-numero"><strong>{{ total_cantidad_sistema2|intcomma }}</strong></th>
                            <th class="col-valor"><strong class="format-currency">${{ total_valor_sistema2|floatformat:2|intcomma }}</strong></th>
                            <th class="col-numero"><strong>{{ total_cantidad_fisico|intcomma }}</strong></th>
                            <th class="col-valor"><strong class="text-primary format-currency">${{ total_valor_fisico|floatformat:2|intcomma }}</strong></th>
                            <th class="col-diferencia">
                                <strong class="{% if diferencia_cantidad_s1 > 0 %}text-success{% elif diferencia_cantidad_s1 < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if diferencia_cantidad_s1 > 0 %}+{% endif %}{{ diferencia_cantidad_s1|intcomma }}
                                </strong>
                            </th>
                            <th class="col-valor">
                                <strong class="format-currency {% if diferencia_valor_s1 > 0 %}text-success{% elif diferencia_valor_s1 < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if diferencia_valor_s1 > 0 %}+{% endif %}${{ diferencia_valor_s1|floatformat:2|intcomma }}
                                </strong>
                            </th>
                            <th class="col-diferencia">
                                <strong class="{% if diferencia_cantidad_s2 > 0 %}text-success{% elif diferencia_cantidad_s2 < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if diferencia_cantidad_s2 > 0 %}+{% endif %}{{ diferencia_cantidad_s2|intcomma }}
                                </strong>
                            </th>
                            <th class="col-valor">
                                <strong class="format-currency {% if diferencia_valor_s2 > 0 %}text-success{% elif diferencia_valor_s2 < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {% if diferencia_valor_s2 > 0 %}+{% endif %}${{ diferencia_valor_s2|floatformat:2|intcomma }}
                                </strong>
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3">
        <a href="{% url 'comparativos:lista' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Volver
        </a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabla = document.getElementById('tabla-comparativo');
    const buscarInput = document.getElementById('buscar-items');
    const filtroDiferencia = document.getElementById('filtro-diferencia');
    const limpiarBtn = document.getElementById('limpiar-filtros');
    const totalItemsBadge = document.getElementById('total-items-badge');
    const filas = tabla.querySelectorAll('tbody tr');
    const totalItems = {{ total_items }};

    function filtrarTabla() {
        const textoBusqueda = buscarInput.value.toLowerCase().trim();
        const filtroDif = filtroDiferencia.value;
        let itemsVisibles = 0;

        filas.forEach(function(fila) {
            // Saltar fila de "No hay items"
            if (fila.querySelector('td[colspan]')) {
                return;
            }

            const textoFila = fila.textContent.toLowerCase();
            const coincideBusqueda = textoBusqueda === '' || textoFila.includes(textoBusqueda);

            // Filtrar por diferencia
            let coincideDiferencia = true;
            if (filtroDif === 's1-con-diferencia') {
                const difS1 = fila.querySelector('td:nth-child(12)');
                const badge = difS1 ? difS1.querySelector('.badge') : null;
                coincideDiferencia = badge && !badge.classList.contains('bg-secondary');
            } else if (filtroDif === 's2-con-diferencia') {
                const difS2 = fila.querySelector('td:nth-child(14)');
                const badge = difS2 ? difS2.querySelector('.badge') : null;
                coincideDiferencia = badge && !badge.classList.contains('bg-secondary');
            } else if (filtroDif === 'sin-diferencia') {
                const difS1 = fila.querySelector('td:nth-child(12)');
                const difS2 = fila.querySelector('td:nth-child(14)');
                const badgeS1 = difS1 ? difS1.querySelector('.badge') : null;
                const badgeS2 = difS2 ? difS2.querySelector('.badge') : null;
                coincideDiferencia = badgeS1 && badgeS1.classList.contains('bg-secondary') &&
                                   badgeS2 && badgeS2.classList.contains('bg-secondary');
            }

            if (coincideBusqueda && coincideDiferencia) {
                fila.style.display = '';
                itemsVisibles++;
            } else {
                fila.style.display = 'none';
            }
        });

        // Actualizar badge
        totalItemsBadge.textContent = itemsVisibles + ' de ' + totalItems + ' items';
        
        // Mostrar mensaje si no hay resultados
        const tbody = tabla.querySelector('tbody');
        let mensajeNoResultados = tbody.querySelector('.no-resultados');
        
        if (itemsVisibles === 0 && (textoBusqueda !== '' || filtroDif !== '')) {
            if (!mensajeNoResultados) {
                mensajeNoResultados = document.createElement('tr');
                mensajeNoResultados.className = 'no-resultados';
                mensajeNoResultados.innerHTML = '<td colspan="16" class="text-center py-3 text-muted"><i class="bi bi-search"></i> No se encontraron items que coincidan con la búsqueda</td>';
                tbody.appendChild(mensajeNoResultados);
            }
        } else {
            if (mensajeNoResultados) {
                mensajeNoResultados.remove();
            }
        }
    }

    // Funcionalidad de ordenamiento
    let sortColumn = null;
    let sortDirection = 'asc';
    
    function ordenarTabla(columna) {
        const tbody = tabla.querySelector('tbody');
        const filas = Array.from(tbody.querySelectorAll('tr:not(.no-resultados)'));
        
        // Si se hace clic en la misma columna, invertir dirección
        if (sortColumn === columna) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = columna;
            sortDirection = 'asc';
        }
        
        // Remover clases de ordenamiento de todos los headers
        tabla.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        
        // Agregar clase de ordenamiento al header actual
        const headerActual = tabla.querySelector(`th[data-sort="${columna}"]`);
        if (headerActual) {
            headerActual.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        }
        
        // Ordenar filas
        filas.sort(function(a, b) {
            let valorA, valorB;
            
            // Mapeo de nombres de columna a atributos data
            const columnaMap = {
                'producto': 'producto',
                'atributo': 'atributo',
                'codigo': 'codigo',
                'codigo-barras': 'codigoBarras',
                'marca': 'marca',
                'precio': 'precio',
                'cant-s1': 'cantS1',
                'valor-s1': 'valorS1',
                'cant-s2': 'cantS2',
                'valor-s2': 'valorS2',
                'cant-fisico': 'cantFisico',
                'valor-fisico': 'valorFisico',
                'dif-cant-s1': 'difCantS1',
                'dif-valor-s1': 'difValorS1',
                'dif-cant-s2': 'difCantS2',
                'dif-valor-s2': 'difValorS2'
            };
            
            const attrName = columnaMap[columna];
            if (!attrName) return 0;
            
            // Obtener valores según el tipo de columna
            if (['precio', 'cantS1', 'valorS1', 'cantS2', 'valorS2', 'cantFisico', 'valorFisico', 
                 'difCantS1', 'difValorS1', 'difCantS2', 'difValorS2'].includes(attrName)) {
                // Valores numéricos
                valorA = parseFloat(a.dataset[attrName] || 0);
                valorB = parseFloat(b.dataset[attrName] || 0);
            } else {
                // Valores de texto
                valorA = (a.dataset[attrName] || '').toLowerCase();
                valorB = (b.dataset[attrName] || '').toLowerCase();
            }
            
            // Comparar valores
            if (valorA < valorB) {
                return sortDirection === 'asc' ? -1 : 1;
            }
            if (valorA > valorB) {
                return sortDirection === 'asc' ? 1 : -1;
            }
            return 0;
        });
        
        // Reordenar filas en el DOM
        filas.forEach(fila => tbody.appendChild(fila));
    }
    
    // Agregar event listeners a los headers ordenables
    tabla.querySelectorAll('th.sortable').forEach(function(header) {
        header.addEventListener('click', function() {
            const columna = this.dataset.sort;
            if (columna) {
                ordenarTabla(columna);
            }
        });
    });
    
    // Event listeners
    buscarInput.addEventListener('input', filtrarTabla);
    filtroDiferencia.addEventListener('change', filtrarTabla);
    
    limpiarBtn.addEventListener('click', function() {
        buscarInput.value = '';
        filtroDiferencia.value = '';
        sortColumn = null;
        sortDirection = 'asc';
        tabla.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('sort-asc', 'sort-desc');
        });
        filtrarTabla();
        buscarInput.focus();
    });

    // Permitir búsqueda con Enter
    buscarInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            filtrarTabla();
        }
    });
    
    // Formatear valores monetarios con separadores de miles
    function formatCurrencyValue(text) {
        // Si el texto ya tiene comas o puntos como separadores de miles, no formatear de nuevo
        if (text.match(/\d{1,3}[.,]\d{3}/)) {
            return text;
        }
        
        // Buscar un solo valor monetario en el texto (puede tener signo + o - al inicio)
        // Patrón: opcionalmente un signo + o -, opcionalmente un $, luego un número con decimales
        const regex = /^([\+\-]?)\$?(\d+(?:\.\d+)?)$/;
        const match = text.trim().match(regex);
        
        if (match) {
            const sign = match[1] || '';
            const number = match[2];
            const num = parseFloat(number);
            
            if (!isNaN(num)) {
                const formatted = num.toLocaleString('es-ES', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                return sign + '$' + formatted;
            }
        }
        
        return text;
    }
    
    // Aplicar formato a todos los valores monetarios con clase format-currency
    // intcomma formatea como: 1,234,567.89 (comas para miles, punto para decimales)
    // Convertir a formato español: 1.234.567,89 (puntos para miles, coma para decimales)
    document.querySelectorAll('.format-currency').forEach(function(el) {
        const originalText = el.textContent.trim();
        // Buscar valores con formato intcomma (tienen comas como separadores de miles)
        // Ejemplo: $1,234,567.89 o +$1,234,567.89
        const match = originalText.match(/([+\-]?)\$([\d,]+\.\d{2})/);
        if (match) {
            const sign = match[1]; // + o -
            const number = match[2]; // 1,234,567.89
            // Convertir comas a puntos (miles) y punto a coma (decimal)
            const formatted = number.replace(/,/g, 'X').replace(/\./g, ',').replace(/X/g, '.');
            el.textContent = sign + '$' + formatted;
        }
    });
});
</script>

<!-- Overlay de carga -->
<div id="loading-overlay" class="loading-overlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <h5 class="mt-3 text-white">Procesando comparativo...</h5>
        <p class="text-white-50 mt-2">Por favor, espere. Esto puede tomar unos momentos.</p>
        <p class="text-white-50 small">Sumando todos los conteos finalizados y procesando productos...</p>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.75);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
}

.loading-content {
    text-align: center;
    padding: 2rem;
    background-color: rgba(0, 0, 0, 0.8);
    border-radius: 10px;
    max-width: 400px;
}

.loading-content .spinner-border {
    border-width: 0.3em;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ocultar el spinner inicial cuando la página esté completamente cargada
    const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    // Función para ocultar el overlay inicial
    function hideInitialOverlay() {
        if (initialLoadingOverlay) {
            setTimeout(function() {
                initialLoadingOverlay.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
        }
    }
    
    // Si la página ya está cargada, ocultar el spinner inmediatamente
    if (document.readyState === 'complete') {
        hideInitialOverlay();
    } else {
        // Esperar a que la página termine de cargar
        window.addEventListener('load', hideInitialOverlay);
    }
    
    // Manejar el overlay para procesar comparativo
    const procesarLinks = document.querySelectorAll('a[href*="procesar"]');
    
    procesarLinks.forEach(function(link) {
        link.addEventListener('click', function(e) {
            // Mostrar el overlay de carga
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                
                // Prevenir que el usuario pueda hacer clic fuera del overlay
                document.body.style.overflow = 'hidden';
            }
            
            // El enlace seguirá su curso normal, pero el usuario verá el spinner
        });
    });
});
</script>
{% endblock %}
